{
  "project": "Switchboard",
  "branchName": "ralph/milestone-h3",
  "description": "Milestone H3 â€” Mirror Worker writes to local git repo. Subscribe to SSE and write commits locally.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create mirror-worker package scaffold",
      "description": "As a developer, I need the mirror-worker package set up with basic structure.",
      "acceptanceCriteria": [
        "packages/mirror-worker/package.json exists with typescript dependency",
        "packages/mirror-worker/tsconfig.json exists extending root config",
        "packages/mirror-worker/src/index.ts exists as entry point",
        "Add eventsource package for SSE client",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Configuration via environment variables",
      "description": "As a developer, I want to configure the mirror worker via env vars.",
      "acceptanceCriteria": [
        "src/config.ts exports getConfig() function",
        "RELAY_URL env var is required (base URL of relay API)",
        "FEED_IDS env var is required (comma-separated list of feed IDs)",
        "CONTEXT_REPO_PATH env var is required (local path to git repo)",
        "COMMIT_BATCH_SIZE env var is optional (default: 10)",
        "COMMIT_BATCH_TIMEOUT_MS env var is optional (default: 5000)",
        "Throws clear error if required vars missing",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "SSE client connection to feeds",
      "description": "As a developer, I want the mirror to connect to feed SSE streams.",
      "acceptanceCriteria": [
        "src/sse.ts exports connectToFeed(relayUrl, feedId, onEvent) function",
        "Connects to {RELAY_URL}/feeds/{feed_id}/stream using eventsource",
        "Logs successful connection to stdout",
        "Parses incoming SSE data messages as JSON events",
        "Calls onEvent callback with parsed event",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "SSE auto-reconnect with exponential backoff",
      "description": "As a developer, I want the mirror to auto-reconnect on disconnect.",
      "acceptanceCriteria": [
        "On SSE connection error or close, attempts reconnect",
        "Uses exponential backoff: 1s, 2s, 4s, 8s, max 30s",
        "Logs reconnection attempts to stdout",
        "Resets backoff to 1s on successful reconnect",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Initialize CRP repo if not exists",
      "description": "As a developer, I want the mirror to initialize the CRP repo if it doesn't exist.",
      "acceptanceCriteria": [
        "src/repo.ts exports initRepo(repoPath) function",
        "If repoPath doesn't exist, creates directory",
        "Runs git init if .git folder doesn't exist",
        "Creates CRP directory structure: events/, snapshots/, policy/, .crp/",
        "Creates .crp/manifest.json with version and created_at",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Write event files to CRP structure",
      "description": "As a developer, I want events written to the correct CRP path.",
      "acceptanceCriteria": [
        "src/repo.ts exports writeEvent(repoPath, event) function",
        "Events written to events/{feed_id}/{YYYY-MM-DD}/{event_id}.json",
        "Date extracted from event ts field",
        "Creates directories if they don't exist",
        "Event file contains full event JSON (pretty-printed with 2-space indent)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Batch commit logic",
      "description": "As a developer, I want commits batched for efficiency.",
      "acceptanceCriteria": [
        "src/committer.ts exports Committer class",
        "Committer accepts batchSize and timeoutMs in constructor",
        "addEvent() method queues an event and triggers commit if batch full",
        "Timeout triggers commit if pending events exist",
        "commit() runs git add -A then git commit -m \"Mirror: add {n} event(s)\"",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Wire up main entry point",
      "description": "As a developer, I want the main entry point to connect all pieces.",
      "acceptanceCriteria": [
        "src/index.ts reads config via getConfig()",
        "Calls initRepo() to ensure repo is initialized",
        "Creates Committer instance with config batch settings",
        "Connects to SSE for each feed in FEED_IDS",
        "On event received, calls writeEvent() then committer.addEvent()",
        "Logs startup message with relay URL and feed count",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Graceful shutdown",
      "description": "As a developer, I want the mirror to commit pending events on shutdown.",
      "acceptanceCriteria": [
        "Listens for SIGINT and SIGTERM signals",
        "On shutdown signal, calls committer.flush() to commit pending events",
        "Closes SSE connections",
        "Logs shutdown message",
        "Exits with code 0 after cleanup",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Integration test for mirror flow",
      "description": "As a developer, I want a test that validates the complete mirror flow.",
      "acceptanceCriteria": [
        "Test creates temp directory for CONTEXT_REPO_PATH",
        "Test creates a feed via relay API (POST /feeds)",
        "Test starts mirror process pointing to temp directory",
        "Test posts 3 events to relay",
        "Test verifies 3 event files exist in correct CRP paths",
        "Test verifies git log shows commit(s)",
        "Test passes",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ]
}
